<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Control de Escaneo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        .correcto { background-color: #d4edda; }
        .faltante { background-color: #f8d7da; }
        .nuevo { background-color: #fff3cd; }
        #scanner {
            width: 100%;
            max-width: 500px;
            height: 300px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>

<h2>Control de Escaneo de Productos</h2>

<!-- Input archivo -->
<label>Subir archivo de inventario (.xlsx):</label>
<input type="file" id="input-inventario" accept=".xlsx, .xls" />
<br><br>

<!-- Input nombre de operador -->
<label>Nombre del operador:</label>
<input type="text" id="input-personal" placeholder="Ej. Juan Pérez" />
<br><br>

<!-- Botones -->
<button id="boton-escaneo">Iniciar escáner</button>
<button id="boton-scan-uno" disabled>Escanear producto</button>

<!-- Cámara -->
<div id="scanner"></div>

<!-- Resultado del código escaneado -->
<div id="codigo-leido" style="margin-top: 10px; font-weight: bold;"></div>

<!-- Tabla de resultados -->
<table id="tabla-resultados">
    <thead>
        <tr>
            <th>Código</th>
            <th>Fabricante</th>
            <th>Cantidad Esperada</th>
            <th>Cantidad Física</th>
            <th>Diferencia</th>
            <th>Estatus</th>
            <th>Observación</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
    let inventario = {};
    let escaneados = {};
    let escaneoActivo = false;
    let esperandoEscaneo = false;

    document.getElementById("input-inventario").addEventListener("change", function(e) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet);

            inventario = {};
            escaneados = {};
            rows.forEach(row => {
                const codigo = String(row["Codigo"]).trim();
                inventario[codigo] = {
                    fabricante: row["Fabricante"] || "-",
                    cantidad: parseInt(row["Cantidad"]) || 0
                };
            });
            actualizarTabla();
        };
        reader.readAsArrayBuffer(this.files[0]);
    });

    function actualizarTabla() {
        const tbody = document.querySelector("#tabla-resultados tbody");
        tbody.innerHTML = "";
        const codigos = new Set([...Object.keys(inventario), ...Object.keys(escaneados)]);

        codigos.forEach(codigo => {
            const item = inventario[codigo] || { fabricante: "-", cantidad: 0 };
            const fisico = escaneados[codigo] || 0;
            const diferencia = item.cantidad - fisico;

            let estatus = "";
            let observacion = "";
            let clase = "";

            if (!(codigo in inventario)) {
                estatus = "Nuevo";
                observacion = "Código no encontrado";
                clase = "nuevo";
            } else if (diferencia === 0) {
                estatus = "Correcto";
                clase = "correcto";
            } else {
                estatus = diferencia > 0 ? `Faltan ${diferencia}` : `Sobra ${-diferencia}`;
                observacion = diferencia > 0 ? "Faltante" : "Exceso";
                clase = "faltante";
            }

            tbody.innerHTML += `
                <tr class="${clase}">
                    <td>${codigo}</td>
                    <td>${item.fabricante}</td>
                    <td>${item.cantidad}</td>
                    <td>${fisico}</td>
                    <td>${diferencia}</td>
                    <td>${estatus}</td>
                    <td>${observacion}</td>
                </tr>`;
        });
    }

    document.getElementById("boton-escaneo").addEventListener("click", function () {
        if (!escaneoActivo) {
            iniciarEscaneo();
            this.textContent = "Detener escáner";
            document.getElementById("boton-scan-uno").disabled = false;
        } else {
            detenerEscaneo();
            this.textContent = "Iniciar escáner";
            document.getElementById("boton-scan-uno").disabled = true;
        }
    });

    function iniciarEscaneo() {
        escaneoActivo = true;
        document.getElementById("scanner").style.display = "block";

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#scanner'),
                constraints: { facingMode: "environment" },
                area: { top: "25%", right: "10%", left: "10%", bottom: "25%" }
            },
            decoder: {
                readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "upc_reader"]
            },
            locate: true
        }, function (err) {
            if (err) {
                console.error(err);
                return;
            }
            Quagga.start();
        });

        Quagga.onDetected(procesarCodigo);
    }

    function detenerEscaneo() {
        escaneoActivo = false;
        esperandoEscaneo = false;
        document.getElementById("scanner").style.display = "none";
        Quagga.stop();
        Quagga.offDetected(procesarCodigo);
    }

    // Botón "Escanear producto" (modo manual)
    document.getElementById("boton-scan-uno").addEventListener("click", function () {
        const operador = document.getElementById("input-personal").value.trim();
        if (!operador) {
            alert("Por favor ingresa el nombre del operador antes de escanear.");
            return;
        }
        esperandoEscaneo = true;
        document.getElementById("codigo-leido").textContent = "Esperando escaneo...";
    });

    function procesarCodigo(result) {
        if (!esperandoEscaneo) return;

        const codigo = result.codeResult.code.trim();
        const operador = document.getElementById("input-personal").value.trim();

        escaneados[codigo] = (escaneados[codigo] || 0) + 1;
        esperandoEscaneo = false;

        document.getElementById("codigo-leido").textContent =
            `Código escaneado: ${codigo} (por ${operador})`;

        actualizarTabla();
    }
</script>

</body>
</html>


