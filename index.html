<script>
    let inventario = {};
    let escaneados = {};
    let ultimoCodigo = null;
    let tiempoUltimoScan = 0;

    // Leer Excel con SheetJS
    document.getElementById("input-inventario").addEventListener("change", function(e) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(sheet);

            inventario = {};
            escaneados = {};
            rows.forEach(row => {
                const codigo = String(row["Codigo"]).trim();
                inventario[codigo] = {
                    fabricante: row["Fabricante"] || "-",
                    cantidad: parseInt(row["Cantidad"]) || 0,
                    fisico: 0,
                    diferencia: 0,
                    estatus: '',
                    observacion: ''
                };
            });
            actualizarTabla();
        };
        reader.readAsArrayBuffer(this.files[0]);
    });

    function actualizarTabla() {
        const tbody = document.querySelector("#tabla-resultados tbody");
        tbody.innerHTML = "";
        const codigos = new Set([...Object.keys(inventario), ...Object.keys(escaneados)]);

        codigos.forEach(codigo => {
            const item = inventario[codigo] || {
                fabricante: "-",
                cantidad: 0,
                fisico: 0,
                diferencia: 0,
                estatus: '',
                observacion: ''
            };

            const fisico = escaneados[codigo] || 0;
            const diferencia = item.cantidad - fisico;

            let estatus = "";
            let observacion = "";
            let clase = "";

            if (!(codigo in inventario)) {
                estatus = "Nuevo";
                observacion = "Código no encontrado en inventario";
                clase = "nuevo";
            } else if (diferencia === 0) {
                estatus = "Correcto";
                clase = "correcto";
            } else {
                estatus = diferencia > 0 ? `Faltan ${diferencia}` : `Sobra ${-diferencia}`;
                observacion = diferencia > 0 ? "Faltante" : "Más de lo esperado";
                clase = "faltante";
            }

            const fila = `
                <tr class="${clase}">
                    <td>${codigo}</td>
                    <td>${item.fabricante}</td>
                    <td>${item.cantidad}</td>
                    <td>${fisico}</td>
                    <td>${diferencia}</td>
                    <td>${estatus}</td>
                    <td>${observacion}</td>
                </tr>
            `;
            tbody.innerHTML += fila;
        });
    }

    // Configurar y arrancar QuaggaJS para escaneo en vivo con cámara
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#scanner'),
            constraints: {
                facingMode: "environment"
            }
        },
        decoder: {
            readers: [
                "code_128_reader",
                "ean_reader",
                "ean_8_reader",
                "code_39_reader",
                "code_39_vin_reader",
                "codabar_reader",
                "upc_reader",
                "upc_e_reader",
                "i2of5_reader"
            ]
        },
        locate: true,
        numOfWorkers: 2,
        halfSample: false
    }, function(err) {
        if (err) {
            console.log("Error al iniciar Quagga:", err);
            return;
        }
        Quagga.start();
    });

    // Evitar duplicados múltiples
    Quagga.onDetected(function(result) {
        if (!result || !result.codeResult || !result.codeResult.code) return;

        const codigo = result.codeResult.code.trim();

        // Filtrar códigos muy cortos (a veces Quagga detecta ruido como códigos de 2 dígitos)
        if (codigo.length < 6) return;

        const ahora = Date.now();
        if (codigo === ultimoCodigo && ahora - tiempoUltimoScan < 2000) {
            return; // ignorar duplicado reciente
        }

        ultimoCodigo = codigo;
        tiempoUltimoScan = ahora;

        escaneados[codigo] = (escaneados[codigo] || 0) + 1;
        actualizarTabla();
    });
</script>

