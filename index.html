<!-- Input para validar personal -->
<label>Personal responsable:</label>
<input type="text" id="input-personal" placeholder="Nombre del operador" />
<br><br>

<!-- Botones -->
<button id="boton-escaneo">Iniciar escáner</button>
<button id="boton-scan-uno" disabled>Escanear producto</button>

<!-- Scanner -->
<div id="scanner"></div>

<!-- Mostrar código leído -->
<div id="codigo-leido"></div>

<script>
    let inventario = {};
    let escaneados = {};
    let escaneoActivo = false;
    let esperandoEscaneo = false;

    document.getElementById("input-inventario").addEventListener("change", function(e) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet);

            inventario = {};
            escaneados = {};
            rows.forEach(row => {
                const codigo = String(row["Codigo"]).trim();
                inventario[codigo] = {
                    fabricante: row["Fabricante"] || "-",
                    cantidad: parseInt(row["Cantidad"]) || 0
                };
            });
            actualizarTabla();
        };
        reader.readAsArrayBuffer(this.files[0]);
    });

    function actualizarTabla() {
        const tbody = document.querySelector("#tabla-resultados tbody");
        tbody.innerHTML = "";
        const codigos = new Set([...Object.keys(inventario), ...Object.keys(escaneados)]);

        codigos.forEach(codigo => {
            const item = inventario[codigo] || { fabricante: "-", cantidad: 0 };
            const fisico = escaneados[codigo] || 0;
            const diferencia = item.cantidad - fisico;

            let estatus = "";
            let observacion = "";
            let clase = "";

            if (!(codigo in inventario)) {
                estatus = "Nuevo";
                observacion = "Código no encontrado";
                clase = "nuevo";
            } else if (diferencia === 0) {
                estatus = "Correcto";
                clase = "correcto";
            } else {
                estatus = diferencia > 0 ? `Faltan ${diferencia}` : `Sobra ${-diferencia}`;
                observacion = diferencia > 0 ? "Faltante" : "Exceso";
                clase = "faltante";
            }

            tbody.innerHTML += `
                <tr class="${clase}">
                    <td>${codigo}</td>
                    <td>${item.fabricante}</td>
                    <td>${item.cantidad}</td>
                    <td>${fisico}</td>
                    <td>${diferencia}</td>
                    <td>${estatus}</td>
                    <td>${observacion}</td>
                </tr>`;
        });
    }

    document.getElementById("boton-escaneo").addEventListener("click", function () {
        if (!escaneoActivo) {
            iniciarEscaneo();
            this.textContent = "Detener escáner";
            document.getElementById("boton-scan-uno").disabled = false;
        } else {
            detenerEscaneo();
            this.textContent = "Iniciar escáner";
            document.getElementById("boton-scan-uno").disabled = true;
        }
    });

    function iniciarEscaneo() {
        escaneoActivo = true;
        document.getElementById("scanner").style.display = "block";

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#scanner'),
                constraints: { facingMode: "environment" },
                area: { top: "25%", right: "10%", left: "10%", bottom: "25%" }
            },
            decoder: {
                readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "upc_reader"]
            },
            locate: true
        }, function (err) {
            if (err) {
                console.error(err);
                return;
            }
            Quagga.start();
        });

        Quagga.onDetected(procesarCodigo);
    }

    function detenerEscaneo() {
        escaneoActivo = false;
        esperandoEscaneo = false;
        document.getElementById("scanner").style.display = "none";
        Quagga.stop();
        Quagga.offDetected(procesarCodigo);
    }

    // NUEVO: Botón escanear uno a uno
    document.getElementById("boton-scan-uno").addEventListener("click", function () {
        const operador = document.getElementById("input-personal").value.trim();
        if (!operador) {
            alert("Por favor ingresa el nombre del operador antes de escanear.");
            return;
        }
        esperandoEscaneo = true;
        document.getElementById("codigo-leido").textContent = "Esperando escaneo...";
    });

    function procesarCodigo(result) {
        if (!esperandoEscaneo) return;

        const codigo = result.codeResult.code.trim();
        const operador = document.getElementById("input-personal").value.trim();

        // Solo capturamos si está activo y esperando
        escaneados[codigo] = (escaneados[codigo] || 0) + 1;
        esperandoEscaneo = false;

        document.getElementById("codigo-leido").textContent =
            `Código escaneado: ${codigo} (por ${operador})`;

        actualizarTabla();
    }
</script>

